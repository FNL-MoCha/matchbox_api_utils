

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>matchbox_api_utils.match_data &mdash; MATCHBox API Utils 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MATCHBox API Utils 1.0.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> MATCHBox API Utils
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">1. MATCHBox API Utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#introduction">1.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#installation">1.2. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#requirements">1.3. Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#using-matchbox-api-utils">1.4. Using MATCHBox API Utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">2. MATCHBox API Utils Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#module-matchbox">2.1. Module: Matchbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#module-matchdata">2.2. Module: MatchData</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial.html#toy-example-1">2.2.1. Toy Example #1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#module-treatmentarms">2.3. Module: TreatmentArms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial.html#toy-example-2">2.3.1. Toy Example #2</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../helper_scripts.html">3. MATCHBox API Utils Helper Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#matchbox-json-dump-matchbox-json-dump-py">3.1. MATCHBox JSON Dump (matchbox_json_dump.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#matchbox-json-dump-help-doc">3.1.1. MATCHBox JSON Dump Help Doc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#map-msn-psn-map-msn-psn-py">3.2. MAP MSN PSN (map_msn_psn.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#map-msn-psn-help-doc">3.2.1. MAP MSN PSN Help Doc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#match-variant-frequency-match-variant-frequency-py">3.3. MATCH Variant Frequency (match_variant_frequency.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#match-variant-frequency-help-docs">3.3.1. MATCH Variant Frequency Help Docs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#matchbox-patient-summary-matchbox-patient-summary-py">3.4. MATCHBox Patient Summary (matchbox_patient_summary.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#matchbox-patient-summary-help-docs">3.4.1. MATCHBox Patient Summary Help Docs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../matchbox_api_utils.html">4. MATCHBox API Utils API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../matchbox_api_utils.html#module-matchbox_api_utils.matchbox">4.1. matchbox_api_utils.matchbox module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../matchbox_api_utils.html#module-matchbox_api_utils.match_data">4.2. matchbox_api_utils.match_data module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../matchbox_api_utils.html#module-matchbox_api_utils.match_arms">4.3. matchbox_api_utils.match_arms module</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MATCHBox API Utils</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>matchbox_api_utils.match_data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for matchbox_api_utils.match_data</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span> <span class="k">as</span> <span class="n">pp</span>

<span class="kn">from</span> <span class="nn">matchbox_api_utils</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">matchbox_api_utils</span> <span class="k">import</span> <span class="n">matchbox_conf</span>

<span class="kn">from</span> <span class="nn">matchbox_api_utils.matchbox</span> <span class="k">import</span> <span class="n">Matchbox</span>
<span class="kn">from</span> <span class="nn">matchbox_api_utils.match_arms</span> <span class="k">import</span> <span class="n">TreatmentArms</span>


<div class="viewcode-block" id="MatchData"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData">[docs]</a><span class="k">class</span> <span class="nc">MatchData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MatchboxData class</span>

<span class="sd">    Parsed MATCHBox Data from the API as collected from the Matchbox class above. </span>
<span class="sd">    This class has methods to generate queries, further filtering, and heuristics </span>
<span class="sd">    on the dataset.</span>

<span class="sd">    Generate a MATCHBox data object that can be parsed and queried downstream </span>
<span class="sd">    with some methods. </span>
<span class="sd">    </span>
<span class="sd">    Can instantiate with either a config JSON file, which contains the url, </span>
<span class="sd">    username, and password information needed to access the resource, or by </span>
<span class="sd">    supplying the individual arguments to make the connection.  This class will </span>
<span class="sd">    call the Matchbox class in order to make the connection and deploy the data.</span>

<span class="sd">    Can do a live query to get data in real time, or load a MATCHBox JSON file </span>
<span class="sd">    derived from the ``matchbox_json_dump.py`` script that is a part of the </span>
<span class="sd">    package.  Since data in MATCHBox is relatively static these days, it&#39;s </span>
<span class="sd">    preferred to use an existing JSON DB and only periodically update the DB with </span>
<span class="sd">    a call to the aforementioned script.</span>

<span class="sd">    Args:</span>
<span class="sd">        config_file (file): Custom config file to use if not using system </span>
<span class="sd">            default.</span>

<span class="sd">        url (str): MATCHBox API URL to use if not using a config file.</span>

<span class="sd">        creds (dict): MATCHBox credentials to use if not using a config file.</span>
<span class="sd">            Needs to be in the form of:</span>

<span class="sd">                ``{&#39;username&#39;:&lt;username&gt;, &#39;password&#39;:&lt;password&gt;}``</span>

<span class="sd">        patient (str): Limit data to a specific PSN.</span>

<span class="sd">        json_db (file): MATCHbox processed JSON file containing the whole</span>
<span class="sd">            dataset. This is usually generated from &#39;matchbox_json_dump.py&#39;. </span>
<span class="sd">            The default value is ``&#39;sys_default&#39;`` which loads the default </span>
<span class="sd">            package data. If you wish you get a live call, set this variable </span>
<span class="sd">            to ``None``.</span>

<span class="sd">        load_raw (file): Load a raw API dataset rather than making a fresh</span>
<span class="sd">            call to the API. This is intended for dev purpose</span>
<span class="sd">            only and will be disabled.</span>

<span class="sd">        make_raw (bool): Make a raw API JSON dataset for dev purposes only.</span>

<span class="sd">        quiet (bool): If True, suppress module output debug, information, etc.</span>
<span class="sd">            messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">creds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">patient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">json_db</span><span class="o">=</span><span class="s1">&#39;sys_default&#39;</span><span class="p">,</span> <span class="n">load_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span> <span class="o">=</span> <span class="n">creds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="n">patient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span> <span class="o">=</span> <span class="n">json_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_raw</span> <span class="o">=</span> <span class="n">load_raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_date</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_today</span><span class="p">(</span><span class="s1">&#39;long&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="n">quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disease_db</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_config_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_config_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="s1">&#39;creds&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+=</span> <span class="s1">&#39;?patientId=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span> 

        <span class="c1"># If json_db is &#39;sys_default&#39;, get json file from matchbox_conf.Config, </span>
        <span class="c1"># which is from matchbox_api_util.__init__.mb_json_data.  Otherwise use </span>
        <span class="c1"># the passed arg; if it&#39;s None, do a live call below, and if it&#39;s a </span>
        <span class="c1"># custom file, load that.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span> <span class="o">==</span> <span class="s1">&#39;sys_default&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_config_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> 
                <span class="s1">&#39;mb_json_data&#39;</span><span class="p">)</span>

        <span class="n">ta_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_config_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span><span class="s1">&#39;ta_json_data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arm_data</span> <span class="o">=</span> <span class="n">TreatmentArms</span><span class="p">(</span><span class="n">json_db</span><span class="o">=</span><span class="n">ta_data</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">make_raw</span><span class="p">:</span>
            <span class="n">Matchbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span><span class="p">,</span> <span class="n">make_raw</span><span class="o">=</span><span class="s1">&#39;mb&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_raw</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  -&gt;  Starting from a raw MB JSON Obj&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_date</span><span class="p">,</span> <span class="n">matchbox_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_dumped_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_raw</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gen_patients_list</span><span class="p">(</span><span class="n">matchbox_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_dumped_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  -&gt;  Starting from a processed MB JSON Obj&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  -&gt;  JSON database object date: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_date</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;filtering on patient: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_by_patient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  -&gt;  Starting from a live MB instance&#39;</span><span class="p">)</span>
            <span class="n">matchbox_data</span> <span class="o">=</span> <span class="n">Matchbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span><span class="p">)</span><span class="o">.</span><span class="n">api_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gen_patients_list</span><span class="p">(</span><span class="n">matchbox_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">)</span>

        <span class="c1"># Load up a medra : ctep term db based on entries so that we can look</span>
        <span class="c1"># data up on the fly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disease_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_disease_db</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__make_disease_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make an on the fly mapping of medra to ctep term db for mapping later</span>
        <span class="c1"># on.  Might make a class and all that later, but for now, since we do</span>
        <span class="c1"># not know how this will be displayed later, this is good enough.</span>
        <span class="n">med_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;medra_code&#39;</span> <span class="ow">in</span> <span class="n">pt</span> <span class="ow">and</span> <span class="n">pt</span><span class="p">[</span><span class="s1">&#39;medra_code&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">med_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">pt</span><span class="p">[</span><span class="s1">&#39;medra_code&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="n">pt</span><span class="p">[</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">med_map</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__filter_by_patient</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">patient</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">[</span><span class="n">patient</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__get_var_data_by_gene</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gene_list</span><span class="p">):</span>
        <span class="c1"># Get variant report data if the gene is in the input gene list.  But, </span>
        <span class="c1"># only output the variant level details, and filter out the VAF, coverage, </span>
        <span class="c1"># etc. so that we can get unqiue lists later.  If we wanted to get </span>
        <span class="c1"># sequence specific details, we&#39;ll run a variant report instead.</span>

        <span class="n">wanted</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;alternative&#39;</span><span class="p">,</span> <span class="s1">&#39;amoi&#39;</span><span class="p">,</span> <span class="s1">&#39;chromosome&#39;</span><span class="p">,</span> <span class="s1">&#39;exon&#39;</span><span class="p">,</span> <span class="s1">&#39;confirmed&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;hgvs&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;oncominevariantclass&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;transcript&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;driverGene&#39;</span><span class="p">,</span>
            <span class="s1">&#39;partnerGene&#39;</span><span class="p">,</span> <span class="s1">&#39;driverReadCount&#39;</span><span class="p">,</span> <span class="s1">&#39;annotation&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;confidenceInterval95percent&#39;</span><span class="p">,</span> <span class="s1">&#39;confidenceInterval5percent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;copyNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;alleleFrequency&#39;</span><span class="p">,</span> <span class="s1">&#39;copyNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;driverReadCount&#39;</span><span class="p">)</span>

        <span class="c1"># This is first iteration, and I can&#39;t remember why I don&#39;t just want </span>
        <span class="c1"># all variant level data any more.  </span>
        <span class="c1"># Deleted bit: </span>
        <span class="c1"># return [elem for elem in data if elem[&#39;gene&#39;] in gene_list ]</span>
        <span class="c1"># return [{i:elem[i] for i in wanted if i in data} for elem in data if elem[&#39;gene&#39;] in gene_list]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">gene_list</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">i</span><span class="p">:</span><span class="n">rec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">results</span>
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__format_id</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msn</span><span class="p">:</span>
            <span class="n">msn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;MSN&#39;</span> <span class="o">+</span> <span class="n">msn</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;MSN&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;rm&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">msn</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;MSN&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: operation &quot;</span><span class="si">%s</span><span class="s1">&quot; is not valid.  Can only &#39;</span>
                    <span class="s1">&#39;choose from &quot;add&quot; or &quot;rm&quot;!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">psn</span><span class="p">:</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">psn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;PSN&#39;</span> <span class="o">+</span> <span class="n">psn</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;PSN&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;rm&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">psn</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;PSN&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: operation &quot;</span><span class="si">%s</span><span class="s1">&quot; is not valid.  Can only &#39;</span>
                    <span class="s1">&#39;choose from &quot;add&quot; or &quot;rm&quot;!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Nothing to do!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__get_patient_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="p">,</span> <span class="n">next_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Output the filtered data table for a PSN so that we have a quick way </span>
        <span class="c1"># to figure out key : value structure for the dataset.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">psn</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">next_key</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">next_key</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">psn</span><span class="p">)][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">psn</span><span class="p">)][</span><span class="n">key</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">psn</span><span class="p">)],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__get_curr_arm</span><span class="p">(</span><span class="n">psn</span><span class="p">,</span> <span class="n">assignment_logic_list</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="c1"># Figure out the arm to which the patient was assinged based on the flag </span>
        <span class="c1"># message found in the TA Logic flow.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;treatmentArmId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">assignment_logic_list</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;reasonCategory&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flag</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># There are exactly 4 cases (as of 9/19/2017) where the patient has </span>
            <span class="c1"># PTEN IHC-, but was not assigned Arm P directly for some reason that </span>
            <span class="c1"># I can&#39;t discern. Instead patient was put on compassionate care for </span>
            <span class="c1"># Arm P, and although I can&#39;t comptutationally derive that since </span>
            <span class="c1"># there is no obvious messsage, I don&#39;t want to lose those results. </span>
            <span class="c1"># So, I&#39;m going to manually enter data for those 4 until I can figure </span>
            <span class="c1"># out how to get this in better.</span>
            <span class="k">if</span> <span class="n">psn</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;13629&#39;</span><span class="p">,</span><span class="s1">&#39;13899&#39;</span><span class="p">,</span><span class="s1">&#39;14007&#39;</span><span class="p">,</span><span class="s1">&#39;14057&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;EAY131-P&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: can not get flag from logic list!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">psn</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;UNK&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__get_pt_hist</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span><span class="n">assignments</span><span class="p">,</span><span class="n">rejoin_triggers</span><span class="p">):</span>
        <span class="c1"># Read the trigger messages to determine the patient treatment and study </span>
        <span class="c1"># arm history.</span>
        <span class="n">arms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">arm_hist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">progressed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tot_msgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span>

        <span class="c1"># If we only ever got to registration and not further (so there&#39;s only 1 </span>
        <span class="c1"># message), let&#39;s bail out</span>
        <span class="k">if</span> <span class="n">tot_msgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">triggers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">],</span> <span class="n">triggers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">],</span> <span class="p">{},</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">triggers</span><span class="p">):</span>
            <span class="c1"># On a rare occassion, we get two of the same messages in a row. Just</span>
            <span class="c1"># skip the redundant message?</span>
            <span class="k">if</span> <span class="n">triggers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REJOIN&#39;</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PENDING_APPROVAL&#39;</span><span class="p">:</span>
                <span class="n">curr_arm</span> <span class="o">=</span> <span class="n">MatchData</span><span class="o">.</span><span class="n">__get_curr_arm</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientSequenceNumber&#39;</span><span class="p">],</span>
                        <span class="n">assignments</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s1">&#39;patientAssignmentLogic&#39;</span><span class="p">],</span> <span class="s1">&#39;SELECTED&#39;</span><span class="p">)</span>
                <span class="n">arms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_arm</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arm_hist</span><span class="p">[</span><span class="n">curr_arm</span><span class="p">]</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s1">&#39;patientAssignmentMessage&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="c1"># We don&#39;t have a message because no actual assignment ever </span>
                    <span class="c1"># made (i.e. OFF_TRIAL before assignment)</span>
                    <span class="n">arm_hist</span><span class="p">[</span><span class="n">curr_arm</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;PROG&quot;</span><span class="p">):</span>
                <span class="n">progressed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">arm_hist</span><span class="p">[</span><span class="n">curr_arm</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FORMERLY_ON_ARM_PROGRESSED&#39;</span>

            <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;COMPASSIONATE_CARE&#39;</span><span class="p">:</span>
                <span class="n">curr_arm</span> <span class="o">=</span> <span class="n">MatchData</span><span class="o">.</span><span class="n">__get_curr_arm</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientSequenceNumber&#39;</span><span class="p">],</span>
                        <span class="n">assignments</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s1">&#39;patientAssignmentLogic&#39;</span><span class="p">],</span> <span class="s1">&#39;ARM_FULL&#39;</span><span class="p">)</span>
                <span class="n">arm_hist</span><span class="p">[</span><span class="n">curr_arm</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;COMPASSIONATE_CARE&#39;</span>

            <span class="c1"># When we hit the last message, return what we&#39;ve collected.</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">tot_msgs</span><span class="p">:</span>
                <span class="n">last_status</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]</span>
                <span class="n">last_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">arms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">last_status</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;OFF_TRIAL&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">arm_hist</span><span class="p">[</span><span class="n">arms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ON_TREATMENT_ARM&#39;</span><span class="p">:</span>
                            <span class="n">arm_hist</span><span class="p">[</span><span class="n">arms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;FORMERLY_ON_ARM_OFF_TRIAL&#39;</span>

                    <span class="k">if</span> <span class="n">arm_hist</span><span class="p">[</span><span class="n">arms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                        <span class="n">arm_hist</span><span class="p">[</span><span class="n">arms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">last_status</span>

                <span class="k">return</span> <span class="n">last_status</span><span class="p">,</span><span class="n">last_msg</span><span class="p">,</span><span class="n">arm_hist</span><span class="p">,</span><span class="n">progressed</span>

    <span class="k">def</span> <span class="nf">__gen_patients_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matchbox_data</span><span class="p">,</span> <span class="n">patient</span><span class="p">):</span>
        <span class="c1">#Process the MATCHBox API data (usually in JSON format from MongoDB) into </span>
        <span class="c1">#a much more concise and easily parsable dict of data. This dict will be </span>
        <span class="c1">#the main dataset used for later data analysis and queries and is the main </span>
        <span class="c1">#structure for the MatchboxData class below.</span>

        <span class="c1">#Args:</span>
            <span class="c1">#matchbox_data (dict): Dict of MATCHBox JSON data to process.</span>
            <span class="c1">#patient (str): Patient identifier (PSN) to filter data.</span>

        <span class="c1">#Returns:</span>
            <span class="c1">#dict: Dict of parsed MATCHBox API data.</span>
        <span class="n">patients</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">matchbox_data</span><span class="p">:</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;patientSequenceNumber&#39;</span><span class="p">]</span>       
            <span class="k">if</span> <span class="n">patient</span> <span class="ow">and</span> <span class="n">psn</span> <span class="o">!=</span> <span class="n">patient</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;psn&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">psn</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;ethnicity&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;ethnicity&#39;</span><span class="p">]</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;patientTriggers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;patientStatus&#39;</span><span class="p">]</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;concordance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;concordance&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">race</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;races&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">race</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;race&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">race</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">ctep_term</span>   <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;diseases&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ctepTerm&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">ctep_term</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctep_term</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">medra_code</span>  <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;diseases&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;medraCode&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">medra_code</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;medra_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">medra_code</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;all_msns&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="p">[]</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;all_biopsies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Get treatment arm history. </span>
            <span class="n">last_status</span><span class="p">,</span> <span class="n">last_msg</span><span class="p">,</span> <span class="n">arm_hist</span><span class="p">,</span> <span class="n">progressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_pt_hist</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;patientTriggers&#39;</span><span class="p">],</span>
                    <span class="n">record</span><span class="p">[</span><span class="s1">&#39;patientAssignments&#39;</span><span class="p">],</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;patientRejoinTriggers&#39;</span><span class="p">])</span>

            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;current_trial_status&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">last_status</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;last_msg&#39;</span><span class="p">]</span>                <span class="o">=</span> <span class="n">last_msg</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;ta_arms&#39;</span><span class="p">]</span>                 <span class="o">=</span> <span class="n">arm_hist</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;progressed&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">progressed</span>
            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]:</span>
                <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No_Biopsy&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">biopsy</span> <span class="ow">in</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]:</span>
                    <span class="n">bsn</span> <span class="o">=</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;biopsySequenceNumber&#39;</span><span class="p">]</span>
                    <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;all_biopsies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bsn</span><span class="p">)</span>
                
                    <span class="n">biopsy_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                    <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ihc&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="s1">&#39;---&#39;</span>
                    <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;biopsy_source&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s1">&#39;---&#39;</span>
                    <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">if</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;failure&#39;</span><span class="p">]:</span>
                        <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;biopsy_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Failed_Biopsy&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;biopsy_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Pass&#39;</span>
                        <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ihc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_ihc_results</span><span class="p">(</span><span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;assayMessagesWithResult&#39;</span><span class="p">])</span>

                        <span class="c1"># Define biopsy type as Initial, Progression, or Outside. </span>
                        <span class="k">if</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;associatedPatientStatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REGISTRATION_OUTSIDE_ASSAY&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">bsn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;T-&#39;</span><span class="p">):</span>
                                <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;biopsy_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Outside_Confirmation&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;biopsy_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Outside&#39;</span>
                        <span class="k">elif</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;associatedPatientStatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PROGRESSION_REBIOPSY&#39;</span><span class="p">:</span>
                            <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;biopsy_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Progression&#39;</span>
                        <span class="k">elif</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;associatedPatientStatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REGISTRATION&#39;</span><span class="p">:</span>
                            <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;biopsy_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Initial&#39;</span>

                        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;nextGenerationSequences&#39;</span><span class="p">]:</span>
                            <span class="c1"># Skip all Failed and Pending reports.</span>
                            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;CONFIRMED&#39;</span><span class="p">:</span>  
                                <span class="k">continue</span> 
                            <span class="n">msn</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ionReporterResults&#39;</span><span class="p">][</span><span class="s1">&#39;molecularSequenceNumber&#39;</span><span class="p">]</span>
                            <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;all_msns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msn</span><span class="p">)</span>

                            <span class="c1"># Now patients are getting an MSN directly from outside assay and put into data like normal,</span>
                            <span class="c1"># but of course no IR stuff. So, we have to filter this.</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">msn</span>
                                <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;ir_runid&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ionReporterResults&#39;</span><span class="p">][</span><span class="s1">&#39;jobName&#39;</span><span class="p">]</span>
                                <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;dna_bam_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ionReporterResults&#39;</span><span class="p">][</span><span class="s1">&#39;dnaBamFilePath&#39;</span><span class="p">]</span>
                                <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;rna_bam_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ionReporterResults&#39;</span><span class="p">][</span><span class="s1">&#39;rnaBamFilePath&#39;</span><span class="p">]</span>
                                <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;vcf_path&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ionReporterResults&#39;</span><span class="p">][</span><span class="s1">&#39;vcfFilePath&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">continue</span>
                                <span class="c1"># print(&#39;offending psn: %s&#39; % psn)</span>

                            <span class="c1"># Get and add MOI data to patient record; might be from outside.</span>
                            <span class="n">variant_report</span>     <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ionReporterResults&#39;</span><span class="p">][</span><span class="s1">&#39;variantReport&#39;</span><span class="p">]</span>
                            <span class="n">biopsy_data</span><span class="p">[</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;mois&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__proc_ngs_data</span><span class="p">(</span><span class="n">variant_report</span><span class="p">))</span>
                    <span class="n">patients</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">biopsy_data</span><span class="p">))</span>
        <span class="c1"># pp(dict(patients))</span>
        <span class="c1"># sys.exit()</span>
        <span class="k">return</span> <span class="n">patients</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__get_ihc_results</span><span class="p">(</span><span class="n">ihc_data</span><span class="p">):</span>
        <span class="c1"># Get and load IHC results from dataset.</span>
        <span class="n">ihc_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;biomarker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ICC&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">ihc_data</span><span class="p">}</span>
        <span class="c1"># Won&#39;t always get RB IHC; depends on if we have other qualifying genomic </span>
        <span class="c1"># event.  Fill in data anyway.</span>
        <span class="k">if</span> <span class="s1">&#39;RB&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ihc_results</span><span class="p">:</span>
            <span class="n">ihc_results</span><span class="p">[</span><span class="s1">&#39;RB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ND&#39;</span>
        <span class="k">return</span> <span class="n">ihc_results</span>

    <span class="k">def</span> <span class="nf">__proc_ngs_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ngs_results</span><span class="p">):</span>
       <span class="c1"># Create and return a dict of variant call data that can be stored in the </span>
       <span class="c1"># patient&#39;s obj.</span>
        <span class="n">variant_call_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">variant_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;singleNucleotideVariants&#39;</span><span class="p">,</span> <span class="s1">&#39;indels&#39;</span><span class="p">,</span> <span class="s1">&#39;copyNumberVariants&#39;</span><span class="p">,</span>
            <span class="s1">&#39;unifiedGeneFusions&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">var_type</span> <span class="ow">in</span> <span class="n">variant_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">ngs_results</span><span class="p">[</span><span class="n">var_type</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;confirmed&#39;</span><span class="p">]:</span>
                    <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gen_variant_dict</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span><span class="n">var_type</span><span class="p">)</span>
                    <span class="n">var_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;amoi&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_data</span><span class="o">.</span><span class="n">map_amoi</span><span class="p">(</span><span class="n">var_data</span><span class="p">)})</span>
                    <span class="n">variant_call_data</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_data</span><span class="p">)</span>

        <span class="c1"># Remap the driver / partner genes so that we know they&#39;re correct, and </span>
        <span class="c1"># add a &#39;gene&#39; field to use later on.</span>
        <span class="k">if</span> <span class="s1">&#39;unifiedGeneFusions&#39;</span> <span class="ow">in</span> <span class="n">variant_call_data</span><span class="p">:</span>
            <span class="n">variant_call_data</span><span class="p">[</span><span class="s1">&#39;unifiedGeneFusions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__remap_fusion_genes</span><span class="p">(</span><span class="n">variant_call_data</span><span class="p">[</span><span class="s1">&#39;unifiedGeneFusions&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">variant_call_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__gen_variant_dict</span><span class="p">(</span><span class="n">vardata</span><span class="p">,</span><span class="n">vartype</span><span class="p">):</span>
        <span class="c1"># Based on input variant call data, return a dict of variant type and wanted fields</span>
        <span class="n">meta_key</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;singleNucleotideVariants&#39;</span> <span class="p">:</span> <span class="s1">&#39;snvs_indels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;indels&#39;</span>                   <span class="p">:</span> <span class="s1">&#39;snvs_indels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;copyNumberVariants&#39;</span>       <span class="p">:</span> <span class="s1">&#39;cnvs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;unifiedGeneFusions&#39;</span>       <span class="p">:</span> <span class="s1">&#39;fusions&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">include_fields</span> <span class="o">=</span> <span class="p">{</span> 
                <span class="s1">&#39;snvs_indels&#39;</span> <span class="p">:</span>  <span class="p">[</span><span class="s1">&#39;alleleFrequency&#39;</span><span class="p">,</span> <span class="s1">&#39;alternative&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;alternativeAlleleObservationCount&#39;</span><span class="p">,</span> <span class="s1">&#39;chromosome&#39;</span><span class="p">,</span> <span class="s1">&#39;exon&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;flowAlternativeAlleleObservationCount&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;flowReferenceAlleleObservations&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;hgvs&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;oncominevariantclass&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;readDepth&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;referenceAlleleObservations&#39;</span><span class="p">,</span> <span class="s1">&#39;transcript&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;confirmed&#39;</span><span class="p">],</span> 
                <span class="s1">&#39;cnvs&#39;</span>        <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;chromosome&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;confidenceInterval5percent&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;confidenceInterval95percent&#39;</span><span class="p">,</span> <span class="s1">&#39;copyNumber&#39;</span><span class="p">,</span><span class="s1">&#39;confirmed&#39;</span><span class="p">],</span>
                <span class="s1">&#39;fusions&#39;</span>     <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;annotation&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;driverReadCount&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;driverGene&#39;</span><span class="p">,</span> <span class="s1">&#39;partnerGene&#39;</span><span class="p">,</span><span class="s1">&#39;confirmed&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">vardata</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">include_fields</span><span class="p">[</span><span class="n">meta_key</span><span class="p">[</span><span class="n">vartype</span><span class="p">]])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_key</span><span class="p">[</span><span class="n">vartype</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__remap_fusion_genes</span><span class="p">(</span><span class="n">fusion_data</span><span class="p">):</span>
        <span class="c1"># Fix the fusion driver / partner annotation since it is not always </span>
        <span class="c1"># correct the way it&#39;s being parsed.  Also add in a &#39;gene&#39; field so that </span>
        <span class="c1"># it&#39;s easier to aggregate data later on (the rest of the elements use </span>
        <span class="c1"># &#39;gene&#39;).</span>
        <span class="n">drivers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ABL1&#39;</span><span class="p">,</span> <span class="s1">&#39;AKT2&#39;</span><span class="p">,</span> <span class="s1">&#39;AKT3&#39;</span><span class="p">,</span> <span class="s1">&#39;ALK&#39;</span><span class="p">,</span> <span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AXL&#39;</span><span class="p">,</span> <span class="s1">&#39;BRAF&#39;</span><span class="p">,</span> <span class="s1">&#39;BRCA1&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;BRCA2&#39;</span><span class="p">,</span> <span class="s1">&#39;CDKN2A&#39;</span><span class="p">,</span> <span class="s1">&#39;EGFR&#39;</span><span class="p">,</span> <span class="s1">&#39;ERBB2&#39;</span><span class="p">,</span> <span class="s1">&#39;ERBB4&#39;</span><span class="p">,</span> <span class="s1">&#39;ERG&#39;</span><span class="p">,</span> <span class="s1">&#39;ETV1&#39;</span><span class="p">,</span> <span class="s1">&#39;ETV1a&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;ETV1b&#39;</span><span class="p">,</span> <span class="s1">&#39;ETV4&#39;</span><span class="p">,</span> <span class="s1">&#39;ETV4a&#39;</span><span class="p">,</span> <span class="s1">&#39;ETV5&#39;</span><span class="p">,</span> <span class="s1">&#39;ETV5a&#39;</span><span class="p">,</span> <span class="s1">&#39;ETV5d&#39;</span><span class="p">,</span> <span class="s1">&#39;FGFR1&#39;</span><span class="p">,</span> <span class="s1">&#39;FGFR2&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;FGFR3&#39;</span><span class="p">,</span> <span class="s1">&#39;FGR&#39;</span><span class="p">,</span> <span class="s1">&#39;FLT3&#39;</span><span class="p">,</span> <span class="s1">&#39;JAK2&#39;</span><span class="p">,</span> <span class="s1">&#39;KRAS&#39;</span><span class="p">,</span> <span class="s1">&#39;MDM4&#39;</span><span class="p">,</span> <span class="s1">&#39;MET&#39;</span><span class="p">,</span> <span class="s1">&#39;MYB&#39;</span><span class="p">,</span> <span class="s1">&#39;MYBL1&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;NF1&#39;</span><span class="p">,</span> <span class="s1">&#39;NOTCH1&#39;</span><span class="p">,</span> <span class="s1">&#39;NOTCH4&#39;</span><span class="p">,</span> <span class="s1">&#39;NRG1&#39;</span><span class="p">,</span> <span class="s1">&#39;NTRK1&#39;</span><span class="p">,</span> <span class="s1">&#39;NTRK2&#39;</span><span class="p">,</span> <span class="s1">&#39;NTRK3&#39;</span><span class="p">,</span> <span class="s1">&#39;NUTM1&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;PDGFRA&#39;</span><span class="p">,</span> <span class="s1">&#39;PDGFRB&#39;</span><span class="p">,</span> <span class="s1">&#39;PIK3CA&#39;</span><span class="p">,</span> <span class="s1">&#39;PPARG&#39;</span><span class="p">,</span> <span class="s1">&#39;PRKACA&#39;</span><span class="p">,</span> <span class="s1">&#39;PRKACB&#39;</span><span class="p">,</span> <span class="s1">&#39;PTEN&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;RAD51B&#39;</span><span class="p">,</span> <span class="s1">&#39;RAF1&#39;</span><span class="p">,</span> <span class="s1">&#39;RB1&#39;</span><span class="p">,</span> <span class="s1">&#39;RELA&#39;</span><span class="p">,</span> <span class="s1">&#39;RET&#39;</span><span class="p">,</span> <span class="s1">&#39;ROS1&#39;</span><span class="p">,</span> <span class="s1">&#39;RSPO2&#39;</span><span class="p">,</span> <span class="s1">&#39;RSPO3&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;TERT&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">fusion</span> <span class="ow">in</span> <span class="n">fusion_data</span><span class="p">:</span>
            <span class="n">gene1</span> <span class="o">=</span> <span class="n">fusion</span><span class="p">[</span><span class="s1">&#39;driverGene&#39;</span><span class="p">]</span>
            <span class="n">gene2</span> <span class="o">=</span> <span class="n">fusion</span><span class="p">[</span><span class="s1">&#39;partnerGene&#39;</span><span class="p">]</span>

            <span class="c1"># handle intragenic fusions</span>
            <span class="k">if</span> <span class="n">gene1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">,</span><span class="s1">&#39;EGFR&#39;</span><span class="p">]:</span>
                <span class="n">driver</span> <span class="o">=</span> <span class="n">partner</span> <span class="o">=</span> <span class="n">gene1</span>

            <span class="c1"># figure out others.</span>
            <span class="k">if</span> <span class="n">gene1</span> <span class="ow">in</span> <span class="n">drivers</span><span class="p">:</span>
                <span class="p">(</span><span class="n">driver</span><span class="p">,</span><span class="n">partner</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">gene1</span><span class="p">,</span><span class="n">gene2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gene2</span> <span class="ow">in</span> <span class="n">drivers</span><span class="p">:</span>
                <span class="p">(</span><span class="n">driver</span><span class="p">,</span><span class="n">partner</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">gene2</span><span class="p">,</span><span class="n">gene1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gene1</span> <span class="ow">in</span> <span class="n">drivers</span> <span class="ow">and</span> <span class="n">gene2</span> <span class="ow">in</span> <span class="n">drivers</span><span class="p">:</span>
                <span class="n">driver</span> <span class="o">=</span> <span class="n">partner</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
            <span class="k">elif</span> <span class="n">gene1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drivers</span> <span class="ow">and</span> <span class="n">gene2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drivers</span><span class="p">:</span>
                <span class="n">driver</span> <span class="o">=</span> <span class="n">partner</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>

            <span class="n">fusion</span><span class="p">[</span><span class="s1">&#39;driverGene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">driver</span>
            <span class="c1"># Also make a &quot;gene&quot; entry so that we can look things up in a similar </span>
            <span class="c1"># way to the other classes.</span>
            <span class="n">fusion</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">driver</span>  
            <span class="n">fusion</span><span class="p">[</span><span class="s1">&#39;partnerGene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partner</span>
        <span class="k">return</span> <span class="n">fusion_data</span>

<div class="viewcode-block" id="MatchData.get_patient_meta"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_patient_meta">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return data for a patient based on a metadata field name. Sometimes we </span>
<span class="sd">        may want to just get a quick bit of data or field for a patient record </span>
<span class="sd">        rather than a whole analysis, and this can be a convenient way to just </span>
<span class="sd">        check a component rather than writing a method to get each and every bit</span>
<span class="sd">        out. If no metaval is entered, will return the whole patient dict.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This function is more for debugging and troubleshooting that for real</span>
<span class="sd">            functionality.</span>

<span class="sd">        Args:</span>
<span class="sd">            psn (str):  PSN of patient for which we want to receive data.</span>
<span class="sd">            val (str):  Optional metaval of data we want. If no entered, will</span>
<span class="sd">                return the entire patient record.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: </span>
<span class="sd">            Either return dict of data if a metaval entered, or whole patient </span>
<span class="sd">            record. Returns ``None`` if no data for a particular record and raises </span>
<span class="sd">            and error if the metaval is not valid for the dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="n">val</span><span class="p">]}</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ERROR: &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid metavalue for this &quot;</span>
                    <span class="s2">&quot;dataset.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span></div>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">])</span>

<div class="viewcode-block" id="MatchData.get_biopsy_summary"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_biopsy_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_biopsy_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ret_type</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dict of patients registered in MATCHBox with biopsy and sequencing</span>
<span class="sd">        information. </span>
<span class="sd">        </span>
<span class="sd">        Categories returned are total PSNs issued (including outside </span>
<span class="sd">        assay patients), total passed biopsies, total failed biopsies (per MDACC </span>
<span class="sd">        message), total MSNs (only counting latest MSN if more than one issued to</span>
<span class="sd">        a biopsy due to a failure) as a method of figuring out how many NAs were </span>
<span class="sd">        prepared, and total with sequencing data.</span>

<span class="sd">        Can filter output based on any one criteria by leveraging the ``category`` </span>
<span class="sd">        variable</span>

<span class="sd">        Args:</span>
<span class="sd">            catetory (str): biopsy category to return. Valid categories are:</span>

<span class="sd">                * pass</span>
<span class="sd">                * failed_biopsy</span>
<span class="sd">                * sequenced</span>
<span class="sd">                * outside</span>
<span class="sd">                * outside_confirmation</span>
<span class="sd">                * progression</span>
<span class="sd">                * initial</span>

<span class="sd">            ret_type (str): Data type to return. Valid types are &quot;counts&quot; and </span>
<span class="sd">                &quot;ids&quot;, where counts is the total number in that category, and </span>
<span class="sd">                ids are the BSNs for the category. Default is &quot;counts&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: </span>
<span class="sd">            Whole set of category : count or single category : count data.</span>

<span class="sd">        Todo: </span>
<span class="sd">            * Fix examples.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; print(data.get_biopsy_summary())</span>
<span class="sd">            {u&#39;sequenced&#39;: 5620, u&#39;msns&#39;: 5620, u&#39;progression&#39;: 9, </span>
<span class="sd">                u&#39;initial&#39;: 5563, u&#39;patients&#39;: 6491, u&#39;outside&#39;: 61, </span>
<span class="sd">                u&#39;no_biopsy&#39;: 465, u&#39;failed_biopsy&#39;: 574, u&#39;pass&#39;: 5654, </span>
<span class="sd">                u&#39;outside_confirmation&#39;: 21}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">count</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No_Biopsy&#39;</span><span class="p">:</span>
                    <span class="n">count</span><span class="p">[</span><span class="s1">&#39;no_biopsy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">bsn</span><span class="p">,</span> <span class="n">biopsy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">biopsy_flag</span> <span class="o">=</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;biopsy_status&#39;</span><span class="p">]</span>
                    <span class="n">source</span>      <span class="o">=</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;biopsy_source&#39;</span><span class="p">]</span>
                    <span class="n">count</span><span class="p">[</span><span class="n">biopsy_flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ids</span><span class="p">[</span><span class="n">biopsy_flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bsn</span><span class="p">)</span> 

                    <span class="c1"># Source will be &#39;---&#39; when a biopsy fails, so exclude those</span>
                    <span class="k">if</span> <span class="n">source</span> <span class="o">!=</span> <span class="s1">&#39;---&#39;</span><span class="p">:</span>
                        <span class="n">count</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">ids</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bsn</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">]:</span>
                        <span class="n">count</span><span class="p">[</span><span class="s1">&#39;sequenced&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;sequenced&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bsn</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;offending record: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">ret_type</span> <span class="o">==</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ret_type</span> <span class="o">==</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">category</span> <span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="n">category</span><span class="p">]}</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: no such category &quot;</span><span class="si">%s</span><span class="s1">&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">category</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span></div>
            <span class="k">return</span> <span class="n">results</span>
    
<div class="viewcode-block" id="MatchData.matchbox_dump"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.matchbox_dump">[docs]</a>    <span class="k">def</span> <span class="nf">matchbox_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump a parsed MATCHBox dataset.</span>
<span class="sd">        </span>
<span class="sd">        Call to the API and make a JSON file that can later be loaded in, rather </span>
<span class="sd">        than making an API call and reprocessing. Useful for quicker look ups as </span>
<span class="sd">        the API call can be very, very slow with such a large DB.</span>

<span class="sd">        .. note:: </span>
<span class="sd">            This is a different dataset than the raw dump.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Filename to use for output. Default filename is:</span>

<span class="sd">                ``mb_obj_&lt;date_generated&gt;.json``</span>

<span class="sd">        Returns:</span>
<span class="sd">            json: </span>
<span class="sd">            MATCHBox API JSON file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span> <span class="o">==</span> <span class="s1">&#39;sys_default&#39;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: You can not use the system default JSON file &#39;</span>
                <span class="s1">&#39;and create a system default JSON. You must use &quot;json_db = None&quot; &#39;</span>
                <span class="s1">&#39;in the call to MatchData!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">formatted_date</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_today</span><span class="p">(</span><span class="s1">&#39;short&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;mb_obj_&#39;</span> <span class="o">+</span> <span class="n">formatted_date</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span></div>
        <span class="n">utils</span><span class="o">.</span><span class="n">make_json</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="MatchData.get_psn"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_psn">[docs]</a>    <span class="k">def</span> <span class="nf">get_psn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bsn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a patient PSN from either an input MSN or BSN.</span>

<span class="sd">        Args:</span>
<span class="sd">            msn (str): A MSN number to query. </span>
<span class="sd">            bsn (str): A BSN number to query.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A PSN that maps to the MSN or BSN input.</span>

<span class="sd">        Examples: </span>
<span class="sd">            &gt;&gt;&gt; print(get_psn(bsn=&#39;T-17-000550&#39;))</span>
<span class="sd">            PSN14420</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_term</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msn</span><span class="p">:</span>
                <span class="n">msn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="n">msn</span><span class="p">)</span>
                <span class="n">query_term</span> <span class="o">=</span> <span class="n">msn</span>
                <span class="k">if</span> <span class="n">msn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;all_msns&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">psn</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bsn</span><span class="p">:</span>
                <span class="n">query_term</span> <span class="o">=</span> <span class="n">bsn</span>
                <span class="k">if</span> <span class="n">bsn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;all_biopsies&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">psn</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: No MSN or BSN entered!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># If we made it here, then we didn&#39;t find a result.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No result for id </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query_term</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="MatchData.get_msn"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_msn">[docs]</a>    <span class="k">def</span> <span class="nf">get_msn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bsn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a patient MSN from either an input PSN or BSN. </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            psn (str): A MSN number to query. </span>
<span class="sd">            bsn (str): A BSN number to query.</span>

<span class="sd">        .. note:: </span>
<span class="sd">            There can always be more than 1 MSN per patient, but can only </span>
<span class="sd">            ever be 1 MSN per biopsy at a time.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of MSNs that correspond with the input PSN or BSN. </span>

<span class="sd">        Examples: </span>
<span class="sd">            &gt;&gt;&gt; print(get_msn(bsn=&#39;T-17-000550&#39;))</span>
<span class="sd">            [u&#39;MSN44180&#39;]</span>

<span class="sd">            &gt;&gt;&gt; print(get_msn(bsn=&#39;T-16-000811&#39;))</span>
<span class="sd">            [u&#39;MSN18184&#39;]</span>

<span class="sd">            &gt;&gt;&gt; print(get_msn(psn=&#39;11583&#39;))</span>
<span class="sd">            [u&#39;MSN18184&#39;, u&#39;MSN41897&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_term</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">psn</span><span class="p">:</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
            <span class="n">query_term</span> <span class="o">=</span> <span class="n">psn</span>
            <span class="k">if</span> <span class="n">psn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;all_msns&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">bsn</span><span class="p">:</span>
            <span class="n">query_term</span> <span class="o">=</span> <span class="n">bsn</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bsn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;all_biopsies&#39;</span><span class="p">]:</span>
                    <span class="n">biopsy_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">bsn</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">biopsy_data</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">]]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># We have a biopsy, but no MSN issued yet (or at all).</span>
                        <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: No PSN or BSN entered!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># If we made it here, then we didn&#39;t find a result.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No result for id </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query_term</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="MatchData.get_bsn"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_bsn">[docs]</a>    <span class="k">def</span> <span class="nf">get_bsn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a patient BSN from either an input PSN or MSN. </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            psn (str): A PSN number to query. </span>
<span class="sd">            msn (str): A MSN number to query.</span>

<span class="sd">        .. note:: </span>
<span class="sd">            Can have more than one BSN per PSN, but can only ever have </span>
<span class="sd">            one BSN / MSN.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list BSNs that correspond to the PSN or MSN input.</span>

<span class="sd">        Examples: </span>
<span class="sd">            &gt;&gt;&gt; print(get_bsn(psn=&#39;14420&#39;))</span>
<span class="sd">            [u&#39;T-17-000550&#39;]</span>

<span class="sd">            &gt;&gt;&gt; print(get_bsn(psn=&#39;11583&#39;))</span>
<span class="sd">            [u&#39;T-16-000811&#39;, u&#39;T-17-000333&#39;] </span>

<span class="sd">            &gt;&gt;&gt; print(get_bsn(msn=&#39;18184&#39;))</span>
<span class="sd">            [u&#39;T-16-000811&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_term</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">psn</span><span class="p">:</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
            <span class="n">query_term</span> <span class="o">=</span> <span class="n">psn</span>
            <span class="k">if</span> <span class="n">psn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">biopsy_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">biopsy_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">biopsy_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;biopsy_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Failed_Biopsy&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">msn</span><span class="p">:</span>
            <span class="n">msn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">msn</span><span class="o">=</span><span class="n">msn</span><span class="p">)</span>
            <span class="n">query_term</span> <span class="o">=</span> <span class="n">msn</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;all_msns&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">msn</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;biopsy_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Failed_Biopsy&#39;</span><span class="p">:</span>
                                <span class="k">return</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: No PSN or MSN entered!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># If we made it here, then we didn&#39;t find a result.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No result for id </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query_term</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="MatchData.get_disease_summary"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_disease_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_disease_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_disease</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query_medra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a summary of registered diseases and counts. With no args, will </span>
<span class="sd">        return a list of all diseases and counts as a dict. One can also limit </span>
<span class="sd">        output to a list of diseases or medra codes and get counts for those only. </span>

<span class="sd">        Args:</span>
<span class="sd">            query_disease (list): List of diseases to filter on.</span>
<span class="sd">            query_medra   (list): List of MEDRA codes to filter on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary of disease(s) and counts in the form of: ::</span>

<span class="sd">            {medra_code : (ctep_term, count)}</span>

<span class="sd">        Todo:</span>
<span class="sd">            * Data is good but should try to filter outside assay data, failed</span>
<span class="sd">              specimens, and progression biopsies (collapsed into one count) to </span>
<span class="sd">              get a value that is closer to the accepted final count.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; data.get_disease_summary(query_medra=[&#39;10006190&#39;])</span>
<span class="sd">            {&#39;10006190&#39;: (u&#39;Invasive breast carcinoma&#39;, 641)}</span>

<span class="sd">            &gt;&gt;&gt; data.get_disease_summary(query_disease=[&#39;Invasive breast carcinoma&#39;])</span>
<span class="sd">            {u&#39;10006190&#39;: (&#39;Invasive breast carcinoma&#39;, 641)} </span>

<span class="sd">            &gt;&gt;&gt; data.get_disease_summary(query_medra=[10006190,10024193,10014735])</span>
<span class="sd">            {&#39;10006190&#39;: (u&#39;Invasive breast carcinoma&#39;, 641),</span>
<span class="sd">             &#39;10014735&#39;: (u&#39;Endometrioid endometrial adenocarcinoma&#39;, 124),</span>
<span class="sd">              &#39;10024193&#39;: (u&#39;Leiomyosarcoma (excluding uterine leiomyosarcoma)&#39;, 57)}</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disease_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">psn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># Skip the registered but not yet biopsied patients.</span>
            <span class="k">if</span> <span class="n">psn</span><span class="p">[</span><span class="s1">&#39;medra_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> 
                <span class="k">continue</span>
            <span class="n">disease_counts</span><span class="p">[</span><span class="n">psn</span><span class="p">[</span><span class="s1">&#39;medra_code&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">query_medra</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_medra</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: arguments to get_disease_summary() must &#39;</span>
                    <span class="s1">&#39;be lists!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> 
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">query_medra</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">disease_counts</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disease_db</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">disease_counts</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MEDRA code &quot;</span><span class="si">%s</span><span class="s1">&quot; was not found in the MATCH &#39;</span>
                        <span class="s1">&#39;study dataset.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query_disease</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_disease</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: arguments to get_disease_summary() must &#39;</span>
                    <span class="s1">&#39;be lists!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> 
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">query_disease</span><span class="p">:</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                    <span class="n">medra</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">medra</span> <span class="k">for</span> <span class="n">medra</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disease_db</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="n">term</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">medra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">medra</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">disease_counts</span><span class="p">[</span><span class="n">medra</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;CTEP Term &quot;</span><span class="si">%s</span><span class="s1">&quot; was not found in the MATCH &#39;</span>
                            <span class="s1">&#39;study dataset.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">medra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disease_db</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">medra</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disease_db</span><span class="p">[</span><span class="n">medra</span><span class="p">],</span> <span class="n">disease_counts</span><span class="p">[</span><span class="n">medra</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span></div>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="MatchData.get_histology"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_histology">[docs]</a>    <span class="k">def</span> <span class="nf">get_histology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bsn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outside</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">no_disease</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dict of PSN:Disease for valid biopsies.  Valid biopsies can </span>
<span class="sd">        are defined as being only `Passed` and can not be `Failed`, `No Biopsy` or</span>
<span class="sd">        outside assay biopsies at this time.</span>

<span class="sd">        Args:</span>
<span class="sd">            psn (str): Optional PSN or comma separated list of PSNs on which </span>
<span class="sd">                to filter data.</span>
<span class="sd">            bsn (str): Optional BSN or comma separated list of BSNs on which </span>
<span class="sd">                to filter data.</span>
<span class="sd">            msn (str): Optional MSN or comma separated list of MSNs on which </span>
<span class="sd">                to filter data.</span>
<span class="sd">            outside (bool): Also include outside assay data. Default: ``False``</span>
<span class="sd">            no_disease (bool): Return all data, even if there is no disease </span>
<span class="sd">                indicated for the patient specimen. Default: ``False``</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dict of ID \: Disease mappings. If no match for input ID, </span>
<span class="sd">            returns ``None``.</span>

<span class="sd">        Examples: </span>
<span class="sd">            &gt;&gt;&gt; data.get_histology(psn=&#39;11352&#39;)</span>
<span class="sd">            {&#39;PSN11352&#39;: u&#39;Serous endometrial adenocarcinoma&#39;}</span>

<span class="sd">            &gt;&gt;&gt; data.get_histology(msn=3060)</span>
<span class="sd">            No result for id MSN3060</span>
<span class="sd">            {&#39;MSN3060&#39;: None}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Don&#39;t want to allow for mixed query types. So, number of None args </span>
        <span class="c1"># must be &gt; 2 or else user incorrectly entered more than one arg type.</span>
        <span class="n">count_none</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">psn</span><span class="p">,</span><span class="n">msn</span><span class="p">,</span><span class="n">bsn</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">count_none</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Error: Mixed query types detected. Please only use &#39;</span>
                <span class="s1">&#39;one type of query ID in this function.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Prepare an ID list dict if one is provided. Need some special mapping </span>
        <span class="c1"># and whatnot before we can pass it.</span>
        <span class="n">query_list</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># always psn : original ID (ex: {&#39;10098&#39;:&#39;T-16-000987&#39;})</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">psn</span><span class="p">:</span>
            <span class="n">psn_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;PSN&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">psn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="n">query_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">psn_list</span><span class="p">,</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">psn</span><span class="o">=</span><span class="n">x</span><span class="p">),</span><span class="n">psn_list</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">query_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">output_data</span><span class="p">[</span><span class="n">query_list</span><span class="p">[</span><span class="n">p</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">elif</span> <span class="n">msn</span><span class="p">:</span>
            <span class="n">msn_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">msn</span><span class="o">=</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">msn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msn_list</span><span class="p">:</span>
                <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_psn</span><span class="p">(</span><span class="n">msn</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">psn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">query_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span><span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">bsn</span><span class="p">:</span>
            <span class="n">bsn_list</span> <span class="o">=</span> <span class="n">bsn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bsn_list</span><span class="p">:</span>
                <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_psn</span><span class="p">(</span><span class="n">bsn</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">psn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">query_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span><span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_data</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psn_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">query_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">psn_list</span><span class="p">,</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">psn</span><span class="o">=</span><span class="n">x</span><span class="p">),</span><span class="n">psn_list</span><span class="p">)))</span>

        <span class="c1"># Iterate through the valid PSNs and get results if they pass filters.</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">psn</span> <span class="ow">in</span> <span class="n">query_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">psn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="c1"># If the no disease filter is turned on (i.e. False) don&#39;t out put </span>
                <span class="c1"># &quot;No Biopsy&quot; results.</span>
                <span class="k">if</span> <span class="n">outside</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s1">&#39;OUTSIDE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]:</span>
                    <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psn</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">no_disease</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psn</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">output_data</span><span class="p">[</span><span class="n">query_list</span><span class="p">[</span><span class="n">psn</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">filtered</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WARN: The following specimens were filtered from the &#39;</span>
                <span class="s1">&#39;output due to either the &quot;outside&quot; or &quot;no_disease&quot; filters:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
</div>
        <span class="k">return</span> <span class="n">output_data</span>

<div class="viewcode-block" id="MatchData.find_variant_frequency"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.find_variant_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">find_variant_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_patients</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and return variant hit rates.</span>

<span class="sd">        Based on an input query in the form of a `variant_type : gene` dict,</span>
<span class="sd">        where the gene value can be a list of genes, output a list of patients</span>
<span class="sd">        that had hits in those gene with some disease and variant information. </span>

<span class="sd">        The return val will be unique to a patient. So, in the cases where we </span>
<span class="sd">        have multiple biopsies from the same patient (an intitial and progression </span>
<span class="sd">        re-biopsy for example), we will only get the union of the two sets, and </span>
<span class="sd">        duplicate variants will not be output.  This will preven the hit rate from </span>
<span class="sd">        getting over inflated.  Also, there is no sequence specific information </span>
<span class="sd">        output in this version (i.e. no VAF, Coverage, etc.).  Sequence level </span>
<span class="sd">        information for a call can be obtained from the method get_variant_report_</span>


<span class="sd">        Args:</span>
<span class="sd">            query (dict): Dictionary of variant_type: gene mappings where: ::</span>

<span class="sd">                -  variant type is one or more of &#39;snvs&#39;, &#39;indels&#39;, &#39;fusions&#39;,</span>
<span class="sd">                    &#39;cnvs&#39;</span>
<span class="sd">                -  gene is a list of genes to query.</span>

<span class="sd">            query_patients (list): List of patients for which we want to obtain </span>
<span class="sd">                data. </span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Return a dict of matching data with disease and MOI information, </span>
<span class="sd">            along with a count of the number of patients queried and the </span>
<span class="sd">            number of biopsies queried.</span>
<span class="sd">        </span>
<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; query={&#39;snvs&#39; : [&#39;BRAF&#39;,&#39;MTOR&#39;], &#39;indels&#39; : [&#39;BRAF&#39;, &#39;MTOR&#39;]}</span>
<span class="sd">            find_variant_frequency(query)</span>

<span class="sd">            &gt;&gt;&gt; pprint(data.find_variant_frequency({&#39;snvs&#39;:[&#39;EGFR&#39;], &#39;indels&#39;:[&#39;EGFR&#39;]}, [15232]))</span>
<span class="sd">            ({&#39;15232&#39;: {&#39;bsns&#39;: [u&#39;T-17-001423&#39;],</span>
<span class="sd">                        &#39;disease&#39;: u&#39;Lung adenocarcinoma&#39;,</span>
<span class="sd">                        &#39;mois&#39;: [{&#39;alternative&#39;: u&#39;T&#39;,</span>
<span class="sd">                                  &#39;amoi&#39;: [u&#39;EAY131-E(i)&#39;, u&#39;EAY131-A(e)&#39;],</span>
<span class="sd">                                  &#39;chromosome&#39;: u&#39;chr7&#39;,</span>
<span class="sd">                                  &#39;confirmed&#39;: True,</span>
<span class="sd">                                  &#39;exon&#39;: u&#39;20&#39;,</span>
<span class="sd">                                  &#39;function&#39;: u&#39;missense&#39;,</span>
<span class="sd">                                  &#39;gene&#39;: u&#39;EGFR&#39;,</span>
<span class="sd">                                  &#39;hgvs&#39;: u&#39;c.2369C&gt;T&#39;,</span>
<span class="sd">                                  &#39;identifier&#39;: u&#39;COSM6240&#39;,</span>
<span class="sd">                                  &#39;oncominevariantclass&#39;: u&#39;Hotspot&#39;,</span>
<span class="sd">                                  &#39;position&#39;: u&#39;55249071&#39;,</span>
<span class="sd">                                  &#39;protein&#39;: u&#39;p.Thr790Met&#39;,</span>
<span class="sd">                                  &#39;reference&#39;: u&#39;C&#39;,</span>
<span class="sd">                                  &#39;transcript&#39;: u&#39;NM_005228.3&#39;,</span>
<span class="sd">                                  &#39;type&#39;: u&#39;snvs_indels&#39;},</span>
<span class="sd">                                 {&#39;alternative&#39;: u&#39;-&#39;,</span>
<span class="sd">                                  &#39;amoi&#39;: [u&#39;EAY131-A(i)&#39;],</span>
<span class="sd">                                  &#39;chromosome&#39;: u&#39;chr7&#39;,</span>
<span class="sd">                                  &#39;confirmed&#39;: True,</span>
<span class="sd">                                  &#39;exon&#39;: u&#39;19&#39;,</span>
<span class="sd">                                  &#39;function&#39;: u&#39;nonframeshiftDeletion&#39;,</span>
<span class="sd">                                  &#39;gene&#39;: u&#39;EGFR&#39;,</span>
<span class="sd">                                  &#39;hgvs&#39;: u&#39;c.2240_2257delTAAGAGAAGCAACATCTC&#39;,</span>
<span class="sd">                                  &#39;identifier&#39;: u&#39;COSM12370&#39;,</span>
<span class="sd">                                  &#39;oncominevariantclass&#39;: u&#39;Hotspot&#39;,</span>
<span class="sd">                                  &#39;position&#39;: u&#39;55242470&#39;,</span>
<span class="sd">                                  &#39;protein&#39;: u&#39;p.Leu747_Pro753delinsSer&#39;,</span>
<span class="sd">                                  &#39;reference&#39;: u&#39;TAAGAGAAGCAACATCTC&#39;,</span>
<span class="sd">                                  &#39;transcript&#39;: u&#39;NM_005228.3&#39;,</span>
<span class="sd">                                  &#39;type&#39;: u&#39;snvs_indels&#39;}],</span>
<span class="sd">                        &#39;msns&#39;: [u&#39;MSN52258&#39;],</span>
<span class="sd">                        &#39;psn&#39;: u&#39;15232&#39;}},</span>
<span class="sd">            1)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">plist</span> <span class="o">=</span> <span class="p">[]</span> 

        <span class="c1"># Queue up a patient&#39;s list in case you just want to find data for one </span>
        <span class="c1"># patient.</span>
        <span class="k">if</span> <span class="n">query_patients</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query_patients</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: You must input the query patients as a &#39;</span>
                    <span class="s1">&#39;list, even if only inputting one!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">pt_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query_patients</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">pt_list</span><span class="p">:</span>
            <span class="c1"># Skip no biopsy and all outside biospy cases.  For outside assay </span>
            <span class="c1"># cases, we don&#39;t want to consider any of it since the confirmation </span>
            <span class="c1"># data will skew results.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;No_Biopsy&#39;</span> <span class="ow">and</span> <span class="s1">&#39;OUTSIDE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">biopsy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]:</span>
                    <span class="n">b_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">biopsy</span><span class="p">]</span>

                    <span class="c1"># Get rid of Outside assays biopsies (but not outside </span>
                    <span class="c1"># confirmation) and Failed biopsies.</span>

                    <span class="k">if</span> <span class="n">b_record</span><span class="p">[</span><span class="s1">&#39;biopsy_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Pass&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">biopsies</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">b_record</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;mois&#39;</span> <span class="ow">in</span> <span class="n">b_record</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">]:</span>
                            <span class="n">plist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patient</span><span class="p">)</span>
                            <span class="n">biopsies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">biopsy</span><span class="p">)</span>
                            <span class="n">input_data</span> <span class="o">=</span> <span class="n">b_record</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;mois&#39;</span><span class="p">]</span>

                            <span class="k">if</span> <span class="s1">&#39;snvs&#39;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">and</span> <span class="s1">&#39;singleNucleotideVariants&#39;</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                                <span class="n">matches</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_var_data_by_gene</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;singleNucleotideVariants&#39;</span><span class="p">],</span>
                                    <span class="n">query</span><span class="p">[</span><span class="s1">&#39;snvs&#39;</span><span class="p">])</span>

                            <span class="k">if</span> <span class="s1">&#39;indels&#39;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">and</span> <span class="s1">&#39;indels&#39;</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                                <span class="n">matches</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_var_data_by_gene</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;indels&#39;</span><span class="p">],</span><span class="n">query</span><span class="p">[</span><span class="s1">&#39;indels&#39;</span><span class="p">])</span>

                            <span class="k">if</span> <span class="s1">&#39;cnvs&#39;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">and</span> <span class="s1">&#39;copyNumberVariants&#39;</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                                <span class="n">matches</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_var_data_by_gene</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;copyNumberVariants&#39;</span><span class="p">],</span><span class="n">query</span><span class="p">[</span><span class="s1">&#39;cnvs&#39;</span><span class="p">])</span>

                            <span class="k">if</span> <span class="s1">&#39;fusions&#39;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">and</span> <span class="s1">&#39;unifiedGeneFusions&#39;</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                                <span class="c1"># input_data[&#39;unifiedGeneFusions&#39;] is a list</span>
                                <span class="n">filtered_fusions</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">fusion</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;unifiedGeneFusions&#39;</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">fusion</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Novel&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fusion</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Non-Targeted&#39;</span><span class="p">):</span> 
                                        <span class="k">continue</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">filtered_fusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fusion</span><span class="p">)</span>
                                <span class="n">matches</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_var_data_by_gene</span><span class="p">(</span><span class="n">filtered_fusions</span><span class="p">,</span><span class="n">query</span><span class="p">[</span><span class="s1">&#39;fusions&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;offending patient record: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">patient</span><span class="p">)</span>
                        <span class="k">raise</span>

                    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">patient</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;psn&#39;</span>      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;psn&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;disease&#39;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;msns&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">patient</span><span class="p">][</span><span class="s1">&#39;all_msns&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;bsns&#39;</span>     <span class="p">:</span> <span class="n">biopsies</span><span class="p">,</span>
                            <span class="s1">&#39;mois&#39;</span>     <span class="p">:</span> <span class="n">matches</span>
                        <span class="p">}</span></div>
        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">plist</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>

<div class="viewcode-block" id="MatchData.get_variant_report"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_variant_report">[docs]</a>    <span class="k">def</span> <span class="nf">get_variant_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. _get_variant_report:</span>

<span class="sd">        Input a PSN or MSN **(preferred!)** and return a list of dicts of variant </span>
<span class="sd">        call data.</span>

<span class="sd">        Since there can be more than one MSN per patient, one will get a more </span>
<span class="sd">        robust result by querying on a MSN.  That is, only one variant report </span>
<span class="sd">        per MSN can be generated and the results, then, will be clear.  In the </span>
<span class="sd">        case of querying by PSN, a variant report for each MSN under that PSN, </span>
<span class="sd">        assuming that the MSN is associated with a variant report, will be </span>
<span class="sd">        returned.</span>

<span class="sd">        Args:</span>
<span class="sd">           msn (str):  MSN for which a variant report should be returned.</span>
<span class="sd">           psn (str):  PSN for which the variant reports should be returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">           dict: List of dicts of variant results. ::</span>

<span class="sd">           msn: { </span>
<span class="sd">               &#39;singleNucleotideVariants&#39; : [{var_data}], </span>
<span class="sd">               &#39;copyNumberVariants&#39; : [{var_data},{var_data}], etc. </span>
<span class="sd">           }</span>

<span class="sd">        Examples:</span>

<span class="sd">        Todo:</span>
<span class="sd">            Add examples here.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msn</span><span class="p">:</span>
            <span class="n">msn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">msn</span><span class="o">=</span><span class="n">msn</span><span class="p">)</span>
            <span class="n">psn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_psn</span><span class="p">(</span><span class="n">msn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span><span class="n">msn</span><span class="o">=</span><span class="n">msn</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">biopsy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;ngs_data&#39;</span> <span class="ow">in</span> <span class="n">biopsy</span> <span class="ow">and</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msn</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">msn</span><span class="o">=</span><span class="n">msn</span><span class="p">)</span> <span class="p">:</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;mois&#39;</span><span class="p">]}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">psn</span><span class="p">:</span>
            <span class="c1"># if we are searching by PSN, can get multiple reports. Print them </span>
            <span class="c1"># all as a list.</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>  
            <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span><span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;all_msns&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No variant report available for patient: &#39;</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">psn</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: Patient </span><span class="si">%s</span><span class="s1"> does not exist in the &#39;</span>
                    <span class="s1">&#39;database!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">biopsy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;biopsies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># Skip the outside assays biopsies since the variant reports are </span>
                <span class="c1"># unreliable for now. Maybe we&#39;ll take these later with an option? </span>
                <span class="c1"># Also have to skip outside confirmation cases now as the assay</span>
                <span class="c1"># does not always cover the variants and now MATCHBox is including </span>
                <span class="c1"># calls that are outside of our reportable range....a real mess!</span>
                <span class="k">if</span> <span class="s1">&#39;Outside&#39;</span> <span class="ow">in</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;biopsy_source&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;mois&#39;</span> <span class="ow">in</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">]:</span>
                    <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">])</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">biopsy</span><span class="p">[</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;mois&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="k">else</span><span class="p">:</span></div>
                <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="MatchData.get_patient_ta_status"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_patient_ta_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_ta_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input a list of PSNs and return information about the treatment arm(s) </span>
<span class="sd">        to which they were assigned, if they were assigned to any arms. If no PSN </span>
<span class="sd">        list is passed to the function, return results for every PSN in the study.</span>

<span class="sd">        Args:</span>
<span class="sd">            psn (str): PSN string to query.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dict of Arm IDs with last status.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; data.get_patient_ta_status(psn=10837)</span>
<span class="sd">            {u&#39;EAY131-Z1A&#39;: u&#39;ON_TREATMENT_ARM&#39;}</span>

<span class="sd">            &gt;&gt;&gt; data.get_patient_ta_status(psn=11889)</span>
<span class="sd">            {u&#39;EAY131-IX1&#39;: u&#39;FORMERLY_ON_ARM_OFF_TRIAL&#39;, </span>
<span class="sd">                    u&#39;EAY131-I&#39;: u&#39;COMPASSIONATE_CARE&#39;}</span>

<span class="sd">            &gt;&gt;&gt; data.get_patient_ta_status(psn=10003)</span>
<span class="sd">            {}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">psn</span><span class="p">:</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_id</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">psn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">psn</span><span class="p">][</span><span class="s1">&#39;ta_arms&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ta_arms&#39;</span><span class="p">]</span></div>
        <span class="k">return</span> <span class="n">results</span> 
    
<div class="viewcode-block" id="MatchData.get_patients_by_disease"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_patients_by_disease">[docs]</a>    <span class="k">def</span> <span class="nf">get_patients_by_disease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">histology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">medra_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input a disease and return a list of patients that were registered with </span>
<span class="sd">        that disease type. For histology query, we can do partial matching based </span>
<span class="sd">        on the python ``in`` function. So, if one were to query `Lung </span>
<span class="sd">        Adenocarcinoma`, `Lung` , `Lung Adeno`, or `Adeno`, all Lung Adenocarinoma </span>
<span class="sd">        cases would be returned.  </span>
<span class="sd">        </span>
<span class="sd">        .. note:: </span>
<span class="sd">            Simply inputting `Lung`, would also return `Non-small Cell Lung </span>
<span class="sd">            Adenocarinoma`, `Squamous Cell Lung Adenocarcinoma`, etc, and querying </span>
<span class="sd">            `Adeno` would return anything that had `adeno`. So, care must be taken </span>
<span class="sd">            with the query, and secondary filtering may be necessary. Querying </span>
<span class="sd">            based on MEDRA codes is specific and only an exact match will return </span>
<span class="sd">            results; **This is the preferred method.**</span>

<span class="sd">        Args:</span>
<span class="sd">            histology (str):  One of the CTEP shotname disease codes.</span>
<span class="sd">            medra_code (str): A MEDRA code to query rather than histology.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dict of Patient : Histology Mapping</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; &lt;put example here&gt;</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">histology</span><span class="p">,</span> <span class="n">medra_code</span><span class="p">]):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ERROR: You must input either a histologie or medra &quot;</span>
                <span class="s2">&quot;code to query!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">histology</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">histology</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pt</span><span class="p">][</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pt</span><span class="p">][</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">medra_code</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">medra_code</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pt</span><span class="p">][</span><span class="s1">&#39;medra_code&#39;</span><span class="p">]:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pt</span><span class="p">][</span><span class="s1">&#39;ctep_term&#39;</span><span class="p">]</span></div>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="MatchData.get_patients_by_arm"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_patients_by_arm">[docs]</a>    <span class="k">def</span> <span class="nf">get_patients_by_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input an official NCI-MATCH arm identifier (e.g. `EAY131-A`) and return</span>
<span class="sd">        a set of patients that have ever qualified for the arm based on variant</span>
<span class="sd">        level data.  This not only includes patients `ON_TREATMENT_ARM`, but also</span>
<span class="sd">        `FORMERLY_ON_ARM_OFF_TRIAL` and even `COMPASSIONATE_CARE`. </span>

<span class="sd">        Args:</span>
<span class="sd">            arm (str): One of the official NCI-MATCH arm identifiers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of tuples of patient, arm, and arm_status.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; print(self.get_patients_by_arm(arm=&#39;EAY131-E&#39;))</span>
<span class="sd">            [</span>
<span class="sd">                (u&#39;11476&#39;, &#39;EAY131-E&#39;, u&#39;OFF_TRIAL_DECEASED&#39;), </span>
<span class="sd">                (u&#39;14343&#39;, &#39;EAY131-E&#39;, u&#39;FORMERLY_ON_ARM_OFF_TRIAL&#39;), </span>
<span class="sd">                (u&#39;10626&#39;, &#39;EAY131-E&#39;, u&#39;ON_TREATMENT_ARM&#39;), </span>
<span class="sd">                (u&#39;14256&#39;, &#39;EAY131-E&#39;, u&#39;ON_TREATMENT_ARM&#39;), </span>
<span class="sd">                (u&#39;16472&#39;, &#39;EAY131-E&#39;, u&#39;FORMERLY_ON_ARM_OFF_TRIAL&#39;)</span>
<span class="sd">            ]</span>

<span class="sd">        &quot;&quot;&quot;</span>
            
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">arm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_data</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: No such arm: </span><span class="si">{}</span><span class="s1">!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arm</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pt</span><span class="p">][</span><span class="s1">&#39;ta_arms&#39;</span><span class="p">]:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pt</span><span class="p">,</span> <span class="n">arm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pt</span><span class="p">][</span><span class="s1">&#39;ta_arms&#39;</span><span class="p">][</span><span class="n">arm</span><span class="p">]))</span></div>
        <span class="k">return</span> <span class="n">results</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__map_ihc_results</span><span class="p">(</span><span class="n">ihc_data</span><span class="p">):</span>
        <span class="c1"># Set up a dict of assays now that we&#39;ll fill in since the number has </span>
        <span class="c1"># changed over time, and it&#39;s good to have results for all assays.</span>
        <span class="n">all_ihc_assays</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RB&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;MSH2&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;MLH1&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;PTEN&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">x</span> <span class="p">:</span> <span class="n">ihc_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_ihc_assays</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>


<div class="viewcode-block" id="MatchData.get_ihc_results"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_data.MatchData.get_ihc_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_ihc_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bsn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assays</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the IHC results for a patient.</span>

<span class="sd">        Input a PSN, MSN, or BSN and / or a set of IHC assays, and return a dict</span>
<span class="sd">        of data. </span>

<span class="sd">        Args:</span>
<span class="sd">            psn (str):  Query the data by PSN. </span>
<span class="sd">            </span>
<span class="sd">            msn (str):  Query the data by MSN.</span>
<span class="sd">            bsn (str):  Query the data by BSN.</span>
<span class="sd">            assay (list): IHC assay for which we want to return results. If no </span>
<span class="sd">                assay is passed, will return all IHC assay results.</span>

<span class="sd">        .. note:: </span>
<span class="sd">            Multiple results will be returned since there can be more than </span>
<span class="sd">            one MSN / PSN.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dict of lists containing the MSN and all IHC assays available </span>
<span class="sd">            for the specimen.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; self.get_ihc_results(msn=&#39;MSN30791&#39;)</span>
<span class="sd">            {&#39;MSN30791&#39;: {&#39;MLH1&#39;: u&#39;POSITIVE&#39;,</span>
<span class="sd">                          &#39;MSH2&#39;: u&#39;POSITIVE&#39;,</span>
<span class="sd">                          &#39;PTEN&#39;: u&#39;POSITIVE&#39;,</span>
<span class="sd">                          &#39;RB&#39;: u&#39;ND&#39;}}</span>

<span class="sd">            &gt;&gt;&gt; get_ihc_results(bsn=&#39;T-16-002222&#39;, assays=[&#39;PTEN&#39;])</span>
<span class="sd">            {u&#39;MSN30791&#39;: {&#39;PTEN&#39;: u&#39;POSITIVE&#39;}}</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">psn</span><span class="p">,</span> <span class="n">msn</span><span class="p">,</span> <span class="n">bsn</span><span class="p">]):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ERROR: You must input an MSN, BSN, or PSN to &quot;</span>
                <span class="s2">&quot; query!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="n">psn</span><span class="p">,</span> <span class="n">msn</span><span class="p">,</span> <span class="n">bsn</span><span class="p">]</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ERROR: Only enter one ID per query. We can not look &quot;</span>
                <span class="s2">&quot;up an MSN and PSN at the same time, for example.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">psn</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patient_meta</span><span class="p">(</span><span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
            <span class="n">bsns</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;all_biopsies&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bsns</span><span class="p">:</span>
                <span class="n">ihc_data</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s1">&#39;ihc&#39;</span><span class="p">]</span>
                <span class="n">msn</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="n">msn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_ihc_results</span><span class="p">(</span><span class="n">ihc_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">msn</span><span class="p">:</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_psn</span><span class="p">(</span><span class="n">msn</span><span class="o">=</span><span class="n">msn</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patient_meta</span><span class="p">(</span><span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;all_biopsies&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">msn</span> <span class="o">==</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">]:</span>
                    <span class="n">ihc_data</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s1">&#39;ihc&#39;</span><span class="p">]</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">msn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_ihc_results</span><span class="p">(</span><span class="n">ihc_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bsn</span><span class="p">:</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_psn</span><span class="p">(</span><span class="n">bsn</span><span class="o">=</span><span class="n">bsn</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patient_meta</span><span class="p">(</span><span class="n">psn</span><span class="o">=</span><span class="n">psn</span><span class="p">)</span>
            <span class="n">ihc_data</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ihc&#39;</span><span class="p">]</span>
            <span class="n">msn</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;biopsies&#39;</span><span class="p">][</span><span class="n">bsn</span><span class="p">][</span><span class="s1">&#39;ngs_data&#39;</span><span class="p">][</span><span class="s1">&#39;msn&#39;</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="n">msn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_ihc_results</span><span class="p">(</span><span class="n">ihc_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">assays</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">filtered_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span> <span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assays</span><span class="p">}</span>
                <span class="n">results</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_results</span>
</div></div>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Dave Sims.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>