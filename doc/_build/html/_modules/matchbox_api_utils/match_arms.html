

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>matchbox_api_utils.match_arms &mdash; MATCHBox API Utils 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MATCHBox API Utils 1.0.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> MATCHBox API Utils
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">1. MATCHBox API Utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#introduction">1.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#installation">1.2. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#requirements">1.3. Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#using-matchbox-api-utils">1.4. Using MATCHBox API Utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">2. MATCHBox API Utils Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#module-matchbox">2.1. Module: Matchbox()</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#module-matchdata">2.2. Module: MatchData()</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial.html#toy-example-1">2.2.1. Toy Example #1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial.html#module-treatmentarms">2.3. Module TreatmentArms()</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../helper_scripts.html">3. MATCHBox API Utils Helper Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#matchbox-json-dump-matchbox-json-dump-py">3.1. MATCHBox JSON Dump (matchbox_json_dump.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#matchbox-json-dump-help-doc">3.1.1. MATCHBox JSON Dump Help Doc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#map-msn-psn-map-msn-psn-py">3.2. MAP MSN PSN (map_msn_psn.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#map-msn-psn-help-doc">3.2.1. MAP MSN PSN Help Doc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#match-variant-frequency-match-variant-frequency-py">3.3. MATCH Variant Frequency (match_variant_frequency.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#match-variant-frequency-help-docs">3.3.1. MATCH Variant Frequency Help Docs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../helper_scripts.html#matchbox-patient-summary-matchbox-patient-summary-py">3.4. MATCHBox Patient Summary (matchbox_patient_summary.py)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../helper_scripts.html#matchbox-patient-summary-help-docs">3.4.1. MATCHBox Patient Summary Help Docs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../matchbox_api_utils.html">4. MATCHBox API Utils API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../matchbox_api_utils.html#module-matchbox_api_utils.matchbox">4.1. matchbox_api_utils.matchbox module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../matchbox_api_utils.html#module-matchbox_api_utils.match_data">4.2. matchbox_api_utils.match_data module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../matchbox_api_utils.html#module-matchbox_api_utils.match_arms">4.3. matchbox_api_utils.match_arms module</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MATCHBox API Utils</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>matchbox_api_utils.match_arms</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for matchbox_api_utils.match_arms</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span> <span class="k">as</span> <span class="n">pp</span>

<span class="kn">from</span> <span class="nn">matchbox_api_utils</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">matchbox_api_utils</span> <span class="k">import</span> <span class="n">matchbox_conf</span>
<span class="kn">from</span> <span class="nn">matchbox_api_utils.matchbox</span> <span class="k">import</span> <span class="n">Matchbox</span>


<div class="viewcode-block" id="TreatmentArms"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_arms.TreatmentArms">[docs]</a><span class="k">class</span> <span class="nc">TreatmentArms</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    **NCI-MATCH Treatment Arms and aMOIs Class**</span>

<span class="sd">    Generate a MATCHBox treatment arms object that can be parsed and queried </span>
<span class="sd">    downstream. </span>
<span class="sd">    </span>
<span class="sd">    Can instantiate with either a config JSON file, which contains the url, </span>
<span class="sd">    username, and password information needed to access the resource, or by </span>
<span class="sd">    supplying the individual arguments to make the connection.  This class</span>
<span class="sd">    will call the Matchbox class in order to make the connection and deploy </span>
<span class="sd">    the data.</span>

<span class="sd">    Can do a live query to get data in real time, or load a MATCHBox JSON file </span>
<span class="sd">    derived from the matchbox_json_dump.py script that is a part of the package. </span>
<span class="sd">    Since data in MATCHBox is relatively static these days, it&#39;s preferred to </span>
<span class="sd">    use an existing JSON DB and only periodically update the DB with a call </span>
<span class="sd">    to the aforementioned script.</span>

<span class="sd">    Args:</span>
<span class="sd">        config_file (file): Custom config file to use if not using system default.</span>

<span class="sd">        url (str): MATCHBox API URL to use.</span>

<span class="sd">        creds (dict): MATCHBox credentials to use. Needs to be in the form of: ::</span>

<span class="sd">            { &#39;username&#39;:&lt;username&gt;, &#39;password&#39;:&lt;password&gt; }</span>

<span class="sd">        json_db (file):     MATCHbox processed JSON file containing the whole </span>
<span class="sd">            dataset. This is usually generated from ``&#39;matchbox_json_dump.py&#39;``. </span>
<span class="sd">            The default value is ``&#39;sys_default&#39;`` which loads the default package </span>
<span class="sd">            data. If you wish you get a live call, set this</span>
<span class="sd">            variable to `&quot;None&quot;`.</span>

<span class="sd">        load_raw (file): Load a raw API dataset rather than making a fresh call </span>
<span class="sd">            to the API. This is intended for dev purpose only and will be </span>
<span class="sd">            disabled in production.</span>

<span class="sd">        make_raw (bool): Make a raw API JSON dataset for dev purposes only.</span>

<span class="sd">    Returns:</span>
<span class="sd">        MATCH Treatment Arms object of data and methods.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">creds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">json_db</span><span class="o">=</span><span class="s1">&#39;sys_default&#39;</span><span class="p">,</span> <span class="n">load_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span> <span class="o">=</span> <span class="n">creds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span> <span class="o">=</span> <span class="n">json_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_raw</span> <span class="o">=</span> <span class="n">load_raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_date</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_today</span><span class="p">(</span><span class="s1">&#39;long&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_config_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="s1">&#39;arms_url&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_creds</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_config_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="s1">&#39;creds&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span> <span class="o">==</span> <span class="s1">&#39;sys_default&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_config_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> 
                <span class="s1">&#39;ta_json_data&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">make_raw</span><span class="p">:</span>
            <span class="n">Matchbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_creds</span><span class="p">,</span><span class="n">make_raw</span><span class="o">=</span><span class="s1">&#39;ta&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_raw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_date</span><span class="p">,</span><span class="n">matchbox_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_dumped_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_raw</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_match_arms_db</span><span class="p">(</span><span class="n">matchbox_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_date</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_dumped_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make api call to get json data; load and present to self.data.</span>
            <span class="n">matchbox_data</span> <span class="o">=</span> <span class="n">Matchbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_creds</span><span class="p">)</span><span class="o">.</span><span class="n">api_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_match_arms_db</span><span class="p">(</span><span class="n">matchbox_data</span><span class="p">)</span>
        
        <span class="c1"># Make a condensed aMOI lookup table too for running aMOIs rules.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gen_rules_table</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>

<div class="viewcode-block" id="TreatmentArms.ta_json_dump"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_arms.TreatmentArms.ta_json_dump">[docs]</a>    <span class="k">def</span> <span class="nf">ta_json_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">amois_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ta_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump the TreatmentArms data to a JSON file that can be easily loaded </span>
<span class="sd">        downstream. We will make both the treatment arms object, as well as the </span>
<span class="sd">        amois lookup table object.</span>

<span class="sd">        Args:</span>
<span class="sd">            amois_filename (str): Name of aMOI lookup JSON file. **Default:**</span>
<span class="sd">                `amoi_lookup_&lt;datestring&gt;.json`</span>
<span class="sd">            ta_filename (str): Name of TA object JSON file **Default:**  </span>
<span class="sd">                `ta_obj_&lt;datestring&gt;.json`</span>

<span class="sd">        Returns:</span>
<span class="sd">            json: </span>
<span class="sd">                ta_obj_&lt;date&gt;.json</span>
<span class="sd">                amois_lookup_&lt;date&gt;.json</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">amois_filename</span><span class="p">:</span>
            <span class="n">amois_filename</span> <span class="o">=</span> <span class="s1">&#39;amoi_lookup_&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_today</span><span class="p">(</span><span class="s1">&#39;short&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ta_filename</span><span class="p">:</span>
            <span class="n">ta_filename</span> <span class="o">=</span> <span class="s1">&#39;ta_obj_&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_today</span><span class="p">(</span><span class="s1">&#39;short&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">make_json</span><span class="p">(</span><span class="n">amois_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">)</span></div>
        <span class="n">utils</span><span class="o">.</span><span class="n">make_json</span><span class="p">(</span><span class="n">ta_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__retrive_data_with_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="n">k1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__gen_rules_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># wanted data struct:</span>
            <span class="c1"># &#39;hotspots&#39; : {</span>
                <span class="c1"># &#39;hs_id&#39; : [arm1, arm2, arm3],</span>
                <span class="c1"># &#39;hs_id&#39; : [arma, armb, armc],</span>
            <span class="c1"># },</span>
            <span class="c1"># &#39;cnvs&#39; : {</span>
                <span class="c1"># &#39;gene1&#39; : [arm1, arm2],</span>
                <span class="c1"># &#39;gene2&#39; : [arma, armb],</span>
            <span class="c1"># },</span>
            <span class="c1"># &#39;fusions&#39; : {</span>
                <span class="c1"># &#39;fusion_id&#39; : [arm1, arm2, arm3],</span>
            <span class="c1"># },</span>
            <span class="c1"># &#39;positional&#39; : {</span>
                <span class="c1"># &#39;gene&#39; : [ &#39;exon|function&#39; : [arms]],</span>
                <span class="c1"># &#39;EGFR&#39; : [ &#39;19|nonframeshiftDeletion&#39; : [ArmA]],</span>
                <span class="c1"># &#39;ERBB2&#39; : [ &#39;20|nonframeshiftInsertion&#39; : [ArmB, ArmBX1]],</span>
            <span class="c1"># }</span>
            <span class="c1"># &#39;deleterious&#39; : {</span>
                 <span class="c1"># &#39;gene&#39; : [arms],</span>
            <span class="c1"># }</span>
        <span class="n">rules_table</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hotspot&#39;</span>     <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
            <span class="s1">&#39;cnv&#39;</span>         <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span> 
            <span class="s1">&#39;fusion&#39;</span>      <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
            <span class="s1">&#39;deleterious&#39;</span> <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
            <span class="s1">&#39;positional&#39;</span>  <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">ie_flag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;True&#39;</span> <span class="p">:</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span> <span class="p">:</span> <span class="s1">&#39;e&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">amoi_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">arm</span><span class="p">][</span><span class="s1">&#39;amois&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">var_type</span> <span class="ow">in</span> <span class="n">rules_table</span><span class="p">:</span>
                <span class="c1"># non_hs mois</span>
                <span class="k">if</span> <span class="n">var_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;deleterious&#39;</span><span class="p">,</span> <span class="s1">&#39;positional&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">amoi_data</span><span class="p">[</span><span class="s1">&#39;non_hs&#39;</span><span class="p">][</span><span class="n">var_type</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">var</span><span class="p">,</span><span class="n">flag</span> <span class="ow">in</span> <span class="n">amoi_data</span><span class="p">[</span><span class="s1">&#39;non_hs&#39;</span><span class="p">][</span><span class="n">var_type</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rules_table</span><span class="p">[</span><span class="n">var_type</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">arm</span><span class="p">,</span><span class="n">ie_flag</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">flag</span><span class="p">)]))</span>
                <span class="c1"># All other mois</span>
                <span class="k">elif</span> <span class="n">amoi_data</span><span class="p">[</span><span class="n">var_type</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">var</span><span class="p">,</span><span class="n">flag</span> <span class="ow">in</span> <span class="n">amoi_data</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">rules_table</span><span class="p">[</span><span class="n">var_type</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">arm</span><span class="p">,</span><span class="n">ie_flag</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">flag</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">rules_table</span>

    <span class="k">def</span> <span class="nf">__parse_amois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amoi_data</span><span class="p">):</span>
        <span class="c1"># Getting a dict of amois with keys:</span>
            <span class="c1"># copyNumberVariants</span>
            <span class="c1"># geneFusions</span>
            <span class="c1"># indels</span>
            <span class="c1"># nonHotspotRules</span>
            <span class="c1"># singleNucleotideVariants</span>

        <span class="n">parsed_amois</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;singleNucleotideVariants&#39;</span> <span class="p">:</span> <span class="s1">&#39;hotspot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;indels&#39;</span>                   <span class="p">:</span> <span class="s1">&#39;hotspot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;copyNumberVariants&#39;</span>       <span class="p">:</span> <span class="s1">&#39;cnv&#39;</span><span class="p">,</span>
            <span class="s1">&#39;geneFusions&#39;</span>              <span class="p">:</span> <span class="s1">&#39;fusion&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nonHotspotRules&#39;</span>          <span class="p">:</span> <span class="s1">&#39;non_hs&#39;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">:</span>
            <span class="c1"># Have to handle non-hs vars a bit differently.</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;nonHotspotRules&#39;</span><span class="p">:</span>
                <span class="n">nhr_vars</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;deleterious&#39;</span> <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> 
                    <span class="s1">&#39;positional&#39;</span> <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">amoi_data</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;oncominevariantclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Deleterious&#39;</span><span class="p">:</span>
                        <span class="n">nhr_vars</span><span class="p">[</span><span class="s1">&#39;deleterious&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;inclusion&#39;</span><span class="p">]})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">var_id</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">],</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;exon&#39;</span><span class="p">],</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]])</span>
                        <span class="n">nhr_vars</span><span class="p">[</span><span class="s1">&#39;positional&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">var_id</span> <span class="p">:</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;inclusion&#39;</span><span class="p">]})</span>
                <span class="n">parsed_amois</span><span class="p">[</span><span class="n">wanted</span><span class="p">[</span><span class="n">var</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nhr_vars</span>
            <span class="k">elif</span> <span class="n">amoi_data</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;matchingId&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;inclusion&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">amoi_data</span><span class="p">[</span><span class="n">var</span><span class="p">]}</span> 
                <span class="n">parsed_amois</span><span class="p">[</span><span class="n">wanted</span><span class="p">[</span><span class="n">var</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># Pad out data</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parsed_amois</span><span class="p">:</span>
                <span class="n">parsed_amois</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">parsed_amois</span>

<div class="viewcode-block" id="TreatmentArms.make_match_arms_db"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_arms.TreatmentArms.make_match_arms_db">[docs]</a>    <span class="k">def</span> <span class="nf">make_match_arms_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Make a database of MATCH Treatment Arms** </span>

<span class="sd">        Read in raw API data and create pared down JSON structure that can be </span>
<span class="sd">        easily parsed later one.  </span>

<span class="sd">        Args:</span>
<span class="sd">            api_data (json): Entire raw MATCHBox API retrieved dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            json: All Arm data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arm_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="n">api_data</span><span class="p">:</span>
            <span class="n">arm_id</span> <span class="o">=</span> <span class="n">arm</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="c1"># if arm_id != &#39;EAY131-Z1A&#39;:</span>
                <span class="c1"># continue</span>

            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">arm</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;arm_id&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">arm</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">arm</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;drug_name&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">arm</span><span class="p">[</span><span class="s1">&#39;targetName&#39;</span><span class="p">]</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;drug_id&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">arm</span><span class="p">[</span><span class="s1">&#39;treatmentArmDrugs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;drugId&#39;</span><span class="p">]</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;assigned&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">arm</span><span class="p">[</span><span class="s1">&#39;numPatientsAssigned&#39;</span><span class="p">]</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;excl_diseases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retrive_data_with_keys</span><span class="p">(</span><span class="n">arm</span><span class="p">[</span><span class="s1">&#39;exclusionDiseases&#39;</span><span class="p">],</span><span class="s1">&#39;shortName&#39;</span><span class="p">,</span><span class="s1">&#39;medraCode&#39;</span><span class="p">)</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;ihc&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retrive_data_with_keys</span><span class="p">(</span><span class="n">arm</span><span class="p">[</span><span class="s1">&#39;assayResults&#39;</span><span class="p">],</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span><span class="s1">&#39;assayResultStatus&#39;</span><span class="p">)</span>
            <span class="n">arm_data</span><span class="p">[</span><span class="n">arm_id</span><span class="p">][</span><span class="s1">&#39;amois&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_amois</span><span class="p">(</span><span class="n">arm</span><span class="p">[</span><span class="s1">&#39;variantReport&#39;</span><span class="p">])</span>
</div>
        <span class="k">return</span> <span class="n">arm_data</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__validate_variant_dict</span><span class="p">(</span><span class="n">variant</span><span class="p">):</span>
        <span class="c1"># Validate that we have enough information to run the aMOIs rules </span>
        <span class="c1"># processing. Will have different amounts of data depending on the source </span>
        <span class="c1"># data. From MATCHBox we&#39;ll get less than user input, and going to need </span>
        <span class="c1">#to account for that.</span>
        <span class="n">acceptable_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;exon&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;oncominevariantclass&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">variant</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cnvs&#39;</span><span class="p">:</span>
                <span class="n">acceptable_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="s1">&#39;gene&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fusions&#39;</span><span class="p">:</span>
                <span class="n">acceptable_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">acceptable_keys</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ERROR: Your variant dict is missing keys. You must &quot;</span>
                <span class="s2">&quot;input all keys:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acceptable_keys</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="TreatmentArms.map_amoi"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_arms.TreatmentArms.map_amoi">[docs]</a>    <span class="k">def</span> <span class="nf">map_amoi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variant</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input a variant dict derived from some kind and return either an aMOI id </span>
<span class="sd">        in the form of Arm(i|e). If variant is not an aMOI, returns ``&#39;None&#39;``.</span>

<span class="sd">        Args:</span>
<span class="sd">            variant (dict):  Variant dict to annotate.  Dict must have the </span>
<span class="sd">                following keys in order to be valid: ::</span>

<span class="sd">                    - type : [snvs_indels, cnvs, fusions]</span>
<span class="sd">                    - oncomineVariantClass</span>
<span class="sd">                    - gene</span>
<span class="sd">                    - identifier (i.e. variant ID (COSM476))</span>
<span class="sd">                    - exon</span>
<span class="sd">                    - function</span>

<span class="sd">                Not all variant types will have meaningful data for these fields,</span>
<span class="sd">                and so fields may be padded with a null char (e.g. &#39;.&#39;, &#39;-&#39;, &#39;NA&#39;, </span>
<span class="sd">                etc.).</span>

<span class="sd">        Returns</span>
<span class="sd">            list:  Arm ID(s) with (i)nclusion or (e)xclusion information.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; variant = { </span>
<span class="sd">                &#39;type&#39; : &#39;snvs_indels&#39;, </span>
<span class="sd">                &#39;gene&#39; : &#39;BRAF&#39;, </span>
<span class="sd">                &#39;identifier&#39; : &#39;COSM476&#39;, </span>
<span class="sd">                &#39;exon&#39; : &#39;15&#39;, </span>
<span class="sd">                &#39;function&#39; : &#39;missense&#39; , </span>
<span class="sd">                &#39;oncominevariantclass&#39; : &#39;Hotspot&#39; </span>
<span class="sd">            }</span>
<span class="sd">            self.map_amoi(variant)</span>
<span class="sd">            [&#39;EAY131-Y(e)&#39;, &#39;EAY131-P(e)&#39;, &#39;EAY131-N(e)&#39;, &#39;EAY131-H(i)&#39;]</span>

<span class="sd">        Todo:</span>
<span class="sd">           Check the examples work.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_variant_dict</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;snvs_indels&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;oncominevariantclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Hotspot&#39;</span> <span class="ow">and</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;hotspot&#39;</span><span class="p">]:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;hotspot&#39;</span><span class="p">][</span><span class="n">variant</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]]</span>

            <span class="k">elif</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;oncominevariantclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Deleterious&#39;</span> <span class="ow">and</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;deleterious&#39;</span><span class="p">]:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;deleterious&#39;</span><span class="p">][</span><span class="n">variant</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;positional&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">variant</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]):</span>
                        <span class="n">gene</span><span class="p">,</span><span class="n">exon</span><span class="p">,</span><span class="n">func</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;exon&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">exon</span> <span class="ow">and</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">func</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;positional&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cnvs&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;cnv&#39;</span><span class="p">]:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;cnv&#39;</span><span class="p">][</span><span class="n">variant</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]]</span>

        <span class="k">elif</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fusions&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;fusion&#39;</span><span class="p">]:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amoi_lookup_table</span><span class="p">[</span><span class="s1">&#39;fusion&#39;</span><span class="p">][</span><span class="n">variant</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span></div>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="TreatmentArms.map_drug_arm"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_arms.TreatmentArms.map_drug_arm">[docs]</a>    <span class="k">def</span> <span class="nf">map_drug_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">armid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">drugname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input an Arm ID or a drug name, and retun a tuple of arm, drugname, and </span>
<span class="sd">        ID. If no arm ID or drug name is input, will return a whole table of all </span>
<span class="sd">        arm data.</span>

<span class="sd">        Args:</span>
<span class="sd">            armid (str): Offcial NCI-MATCH Arm ID in the form of `EAY131-xxx` (e.g. </span>
<span class="sd">                &#39;EAY131-Z1A&#39;).</span>
<span class="sd">            drugname (str): Drug name as registered in the NCI-MATCH subprotocols.  </span>
<span class="sd">                Right now, required to have the full string (e.g. &#39;MLN0128(TAK-228)&#39; </span>
<span class="sd">                or, unfortunately, &#39;Sunitinib malate (SU011248 L-malate)&#39;), but </span>
<span class="sd">                will work on a regex to help make this easier later on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of tuples or ``None``.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; map_drug_arm(armid=&#39;EAY131-Z1A&#39;)</span>
<span class="sd">            (u&#39;EAY131-Z1A&#39;, &#39;Binimetinib&#39;, u&#39;788187&#39;)</span>

<span class="sd">        Todo:</span>
<span class="sd">            Write regex for drug name mapping so that we don&#39;t need to deal with </span>
<span class="sd">            long, cryptic strings.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">armid</span><span class="p">,</span><span class="n">drugname</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">arm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">arm</span><span class="p">][</span><span class="s1">&#39;drug_name&#39;</span><span class="p">],</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">arm</span><span class="p">][</span><span class="s1">&#39;drug_id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">armid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">armid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>     
                <span class="k">return</span> <span class="p">(</span><span class="n">armid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">armid</span><span class="p">][</span><span class="s1">&#39;drug_name&#39;</span><span class="p">],</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">armid</span><span class="p">][</span><span class="s1">&#39;drug_id&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">drugname</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">arm</span><span class="p">][</span><span class="s1">&#39;drug_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">drugname</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">arm</span><span class="p">][</span><span class="s1">&#39;arm_id&#39;</span><span class="p">],</span><span class="n">drugname</span><span class="p">,</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">arm</span><span class="p">][</span><span class="s1">&#39;drug_id&#39;</span><span class="p">])</span></div>
        <span class="k">return</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="TreatmentArms.get_exclusion_disease"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_arms.TreatmentArms.get_exclusion_disease">[docs]</a>    <span class="k">def</span> <span class="nf">get_exclusion_disease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">armid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input an arm ID and return a list of exclusionary diseases for the arm, </span>
<span class="sd">        if there are any. Otherwise return ``None``.</span>

<span class="sd">        Args:</span>
<span class="sd">            armid (str): Full identifier of the arm to be queried.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of exclusionary diseases for the arm, or ``None`` if there </span>
<span class="sd">            aren&#39;t any.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; get_exclusion_disease(&#39;EAY131-Z1A&#39;)</span>
<span class="sd">            [u&#39;Melanoma&#39;, u&#39;Colorectal Cancer&#39;]</span>

<span class="sd">            &gt;&gt;&gt; get_exclusion_disease(&#39;EAY131-Y&#39;)</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">armid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">armid</span><span class="p">][</span><span class="s1">&#39;excl_diseases&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">armid</span><span class="p">][</span><span class="s1">&#39;excl_diseases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: No arm with ID: &quot;</span><span class="si">%s</span><span class="s1">&quot; found in study!&#39;</span> <span class="o">%</span> <span class="n">armid</span><span class="p">)</span></div>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="TreatmentArms.get_amois_by_arm"><a class="viewcode-back" href="../../matchbox_api_utils.html#matchbox_api_utils.match_arms.TreatmentArms.get_amois_by_arm">[docs]</a>    <span class="k">def</span> <span class="nf">get_amois_by_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input an arm identifier and return a list of aMOIs for the arm broken</span>
<span class="sd">        down by category.</span>

<span class="sd">        Args:</span>
<span class="sd">            arm (str):  Arm identifier to query</span>

<span class="sd">        Returns:</span>

<span class="sd">        Todo:</span>
<span class="sd">            Need to finish implementing this method.  Currently only dumping a </span>
<span class="sd">            dict.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">arm_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">arm</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ERROR: No arm with ID: &quot;</span><span class="si">%s</span><span class="s1">&quot; found in study!</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">arm</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Iterate through hotspots, cnvs, fusions, and non-hs aMOIs and generate</span>
        <span class="c1"># a list of tuples of data that can be printed easily later.</span>

        <span class="c1">#TODO: implement this.  For now just dump out dict.</span></div></div>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arm_data</span><span class="p">[</span><span class="s1">&#39;amois&#39;</span><span class="p">])</span>

</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Dave Sims.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>